name: Benchmark

on:
  release:
    types: [published]
  pull_request:
    types: [labeled]
  workflow_dispatch:
    inputs:
      mode:
        description: 'Benchmark mode'
        required: false
        type: choice
        options:
          - fast
          - med
          - metal
        default: fast
      duration:
        description: 'Benchmark duration (e.g., 10s, 30s, 60s)'
        required: false
        default: ''
      bench_mode:
        description: 'Servers to benchmark'
        required: false
        type: choice
        options:
          - all
          - baseline
          - theoretical
        default: all

env:
  AWS_REGION: us-east-1

jobs:
  # Deploy PR-specific C2 for pull request benchmarks
  deploy-pr-c2:
    name: Deploy PR C2
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: |
      github.event_name == 'pull_request' &&
      (github.event.label.name == 'bench-fast' ||
       github.event.label.name == 'bench-med' ||
       github.event.label.name == 'bench-metal')
    outputs:
      c2_url: ${{ steps.deploy.outputs.c2_url }}
      stack_name: ${{ steps.deploy.outputs.stack_name }}

    steps:
      - name: Checkout PR Code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'

      - name: Build C2 Binary
        run: |
          echo "Building C2 binary from PR code..."
          GOOS=linux GOARCH=amd64 go build -o c2-linux-amd64 ./cmd/c2
          ls -la c2-linux-amd64

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Upload C2 Binary to S3
        id: upload
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          BUCKET="celeris-artifacts-${{ secrets.AWS_ACCOUNT_ID }}"
          KEY="pr-c2/pr-${PR_NUMBER}/c2-linux-amd64"

          # Create bucket if it doesn't exist
          aws s3api head-bucket --bucket "$BUCKET" 2>/dev/null || \
            aws s3api create-bucket --bucket "$BUCKET" --region ${{ env.AWS_REGION }}

          # Upload binary
          aws s3 cp c2-linux-amd64 "s3://${BUCKET}/${KEY}"

          # Generate presigned URL (valid for 4 hours)
          URL=$(aws s3 presign "s3://${BUCKET}/${KEY}" --expires-in 14400)
          echo "binary_url=$URL" >> $GITHUB_OUTPUT
          echo "Uploaded C2 binary to S3"

      - name: Get Main C2 Stack Outputs
        id: main-c2
        run: |
          # Get security group and instance profile from main C2 stack
          WORKER_SG=$(aws cloudformation describe-stacks --stack-name celeris-c2 \
            --query 'Stacks[0].Outputs[?OutputKey==`WorkerSecurityGroupId`].OutputValue' --output text)
          WORKER_PROFILE=$(aws cloudformation describe-stacks --stack-name celeris-c2 \
            --query 'Stacks[0].Outputs[?OutputKey==`WorkerInstanceProfileArn`].OutputValue' --output text)
          C2_SG=$(aws cloudformation describe-stacks --stack-name celeris-c2 \
            --query 'Stacks[0].Outputs[?OutputKey==`C2SecurityGroupId`].OutputValue' --output text)

          echo "worker_sg=$WORKER_SG" >> $GITHUB_OUTPUT
          echo "worker_profile=$WORKER_PROFILE" >> $GITHUB_OUTPUT
          echo "c2_sg=$C2_SG" >> $GITHUB_OUTPUT

      - name: Deploy PR C2 Stack
        id: deploy
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          STACK_NAME="celeris-c2-pr-${PR_NUMBER}"

          echo "Deploying PR C2 stack: $STACK_NAME"

          aws cloudformation deploy \
            --template-file cloudformation/c2-pr.yaml \
            --stack-name "$STACK_NAME" \
            --capabilities CAPABILITY_NAMED_IAM \
            --parameter-overrides \
              PRNumber="$PR_NUMBER" \
              VpcId="${{ secrets.VPC_ID }}" \
              SubnetId="${{ secrets.SUBNET_ID }}" \
              ApiKey="${{ secrets.C2_API_KEY }}" \
              GitHubToken="${{ secrets.GH_PAT_RUNNER_TOKEN }}" \
              C2BinaryUrl="${{ steps.upload.outputs.binary_url }}" \
              MainC2SecurityGroupId="${{ steps.main-c2.outputs.c2_sg }}" \
              WorkerSecurityGroupId="${{ steps.main-c2.outputs.worker_sg }}" \
              WorkerInstanceProfileArn="${{ steps.main-c2.outputs.worker_profile }}" \
            --tags \
              Project=celeris-benchmarks \
              PRNumber="$PR_NUMBER" \
            --no-fail-on-empty-changeset

          # Get outputs
          C2_IP=$(aws cloudformation describe-stacks --stack-name "$STACK_NAME" \
            --query 'Stacks[0].Outputs[?OutputKey==`PRC2PublicIP`].OutputValue' --output text)
          C2_URL="http://${C2_IP}:8080"

          echo "stack_name=$STACK_NAME" >> $GITHUB_OUTPUT
          echo "c2_url=$C2_URL" >> $GITHUB_OUTPUT
          echo "PR C2 deployed at: $C2_URL"

      - name: Wait for PR C2 to be Healthy
        run: |
          C2_URL="${{ steps.deploy.outputs.c2_url }}"
          echo "Waiting for PR C2 to be healthy at $C2_URL..."

          for i in {1..60}; do
            if curl -sf "$C2_URL/api/health" > /dev/null 2>&1; then
              echo "PR C2 is healthy!"
              exit 0
            fi
            echo "Attempt $i/60: PR C2 not ready yet..."
            sleep 10
          done

          echo "::error::PR C2 health check failed"
          exit 1

  # Main benchmark job
  benchmark:
    name: Run Benchmark
    runs-on: ubuntu-latest
    timeout-minutes: 240
    needs: [deploy-pr-c2]
    # Run if deploy-pr-c2 succeeded OR if this isn't a PR (release/manual)
    if: |
      always() &&
      (github.event_name == 'release' ||
       github.event_name == 'workflow_dispatch' ||
       (github.event_name == 'pull_request' && needs.deploy-pr-c2.result == 'success'))
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Determine C2 URL
        id: c2
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            # Use PR-specific C2
            C2_URL="${{ needs.deploy-pr-c2.outputs.c2_url }}"
            echo "Using PR C2: $C2_URL"
          else
            # Use main C2 for releases and manual triggers
            C2_URL="${{ secrets.C2_URL }}"
            echo "Using main C2: $C2_URL"
          fi
          echo "c2_url=$C2_URL" >> $GITHUB_OUTPUT

      - name: Determine Benchmark Mode
        id: mode
        run: |
          if [[ "${{ github.event_name }}" == "release" ]]; then
            echo "mode=metal" >> $GITHUB_OUTPUT
            echo "Running METAL benchmarks for release"
          elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
            # Determine mode from label
            LABEL="${{ github.event.label.name }}"
            case "$LABEL" in
              bench-fast) MODE="fast" ;;
              bench-med)  MODE="med" ;;
              bench-metal) MODE="metal" ;;
              *) MODE="fast" ;;
            esac
            echo "mode=$MODE" >> $GITHUB_OUTPUT
            echo "Running $MODE benchmarks for PR (label: $LABEL)"
          else
            echo "mode=${{ inputs.mode || 'fast' }}" >> $GITHUB_OUTPUT
            echo "Running ${{ inputs.mode || 'fast' }} benchmarks (manual trigger)"
          fi

      - name: Start Benchmark
        id: start
        run: |
          C2_URL="${{ steps.c2.outputs.c2_url }}"
          echo "Starting benchmark (mode: ${{ steps.mode.outputs.mode }}) against $C2_URL"

          PARAMS="mode=${{ steps.mode.outputs.mode }}"
          if [[ -n "${{ inputs.duration }}" ]]; then
            PARAMS="$PARAMS&duration=${{ inputs.duration }}"
          fi
          if [[ -n "${{ inputs.bench_mode }}" ]]; then
            PARAMS="$PARAMS&bench_mode=${{ inputs.bench_mode }}"
          fi

          RESPONSE=$(curl -sf -X POST \
            -H "X-API-Key: ${{ secrets.C2_API_KEY }}" \
            "$C2_URL/api/benchmark/start?$PARAMS")

          RUN_ID=$(echo "$RESPONSE" | jq -r '.run_id')
          if [[ -z "$RUN_ID" || "$RUN_ID" == "null" ]]; then
            echo "::error::Failed to start benchmark: $RESPONSE"
            exit 1
          fi

          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT
          echo "Benchmark started: $RUN_ID"

      - name: Wait for Completion
        run: |
          C2_URL="${{ steps.c2.outputs.c2_url }}"
          RUN_ID="${{ steps.start.outputs.run_id }}"
          echo "Waiting for benchmark $RUN_ID to complete..."

          POLL_INTERVAL=30
          MAX_WAIT=14400  # 4 hours
          ELAPSED=0
          LAST_QUEUE_POS=0
          PLACEMENT_SHOWN=false

          while [ $ELAPSED -lt $MAX_WAIT ]; do
            RESPONSE=$(curl -sf \
              -H "X-API-Key: ${{ secrets.C2_API_KEY }}" \
              "$C2_URL/api/benchmark/$RUN_ID/status" || echo '{"status":"unknown"}')

            STATUS=$(echo "$RESPONSE" | jq -r '.status')

            case $STATUS in
              completed)
                echo "Benchmark completed successfully!"
                exit 0
                ;;
              failed|cancelled)
                ERROR=$(echo "$RESPONSE" | jq -r '.error // "Unknown error"')
                echo "::error::Benchmark failed: $ERROR"
                exit 1
                ;;
              queued)
                # Show queue position
                QUEUE_POS=$(echo "$RESPONSE" | jq -r '.queue_position // 0')
                if [[ "$QUEUE_POS" != "$LAST_QUEUE_POS" ]]; then
                  echo "[$((ELAPSED/60))m] Queued - position $QUEUE_POS (waiting for capacity)"
                  LAST_QUEUE_POS=$QUEUE_POS
                fi
                ;;
              pending|running)
                # Show worker placement info once when workers register
                if [[ "$PLACEMENT_SHOWN" == "false" ]]; then
                  WORKERS=$(echo "$RESPONSE" | jq -c '.workers // {}')
                  if [[ "$WORKERS" != "{}" ]]; then
                    WORKER_COUNT=$(echo "$WORKERS" | jq 'keys | length')
                    if [[ "$WORKER_COUNT" -gt 0 ]]; then
                      echo ""
                      echo "=== Worker Placement ==="
                      for arch in arm64 x86; do
                        for role in server client; do
                          KEY="${arch}-${role}"
                          WORKER=$(echo "$RESPONSE" | jq -r ".workers[\"$KEY\"] // {}")
                          if [[ "$WORKER" != "{}" && "$WORKER" != "null" ]]; then
                            W_TYPE=$(echo "$WORKER" | jq -r '.instance_type // "unknown"')
                            W_REGION=$(echo "$WORKER" | jq -r '.region // "unknown"')
                            W_AZ=$(echo "$WORKER" | jq -r '.az // "unknown"')
                            echo "  $arch $role: $W_TYPE in $W_REGION ($W_AZ)"
                          fi
                        done
                      done
                      echo "========================="
                      echo ""
                      PLACEMENT_SHOWN=true
                    fi
                  fi
                fi

                # Show progress
                echo "[$((ELAPSED/60))m] Status: $STATUS"
                WORKERS=$(echo "$RESPONSE" | jq -c '.workers // {}')
                if [[ "$WORKERS" != "{}" ]]; then
                  # Extract and display progress from workers
                  for arch in arm64 x86; do
                    CLIENT_KEY="${arch}-client"
                    CLIENT=$(echo "$RESPONSE" | jq -r ".workers[\"$CLIENT_KEY\"] // {}")
                    if [[ "$CLIENT" != "{}" && "$CLIENT" != "null" ]]; then
                      CURRENT_SERVER=$(echo "$CLIENT" | jq -r '.current_server // ""')
                      CURRENT_BENCH=$(echo "$CLIENT" | jq -r '.current_benchmark // ""')
                      CURRENT_COUNT=$(echo "$CLIENT" | jq -r '.current_count // 0')
                      TOTAL_COUNT=$(echo "$CLIENT" | jq -r '.total_count // 0')

                      if [[ -n "$CURRENT_SERVER" && -n "$CURRENT_BENCH" && "$TOTAL_COUNT" -gt 0 ]]; then
                        echo "  $arch: Testing $CURRENT_SERVER/$CURRENT_BENCH ($CURRENT_COUNT/$TOTAL_COUNT)"
                      fi
                    fi
                  done
                fi
                ;;
              *)
                echo "[$((ELAPSED/60))m] Unknown status: $STATUS"
                ;;
            esac

            sleep $POLL_INTERVAL
            ELAPSED=$((ELAPSED + POLL_INTERVAL))
          done

          echo "::error::Timeout waiting for benchmark completion"
          exit 1

      - name: Get Full Results
        id: results
        if: success()
        run: |
          C2_URL="${{ steps.c2.outputs.c2_url }}"
          RUN_ID="${{ steps.start.outputs.run_id }}"
          if [[ -z "$RUN_ID" ]]; then
            echo "No run ID available"
            exit 0
          fi

          # Fetch full results
          RESULTS=$(curl -sf \
            -H "X-API-Key: ${{ secrets.C2_API_KEY }}" \
            "$C2_URL/api/benchmark/$RUN_ID/results" || echo '{}')

          # Store results for later steps
          echo "$RESULTS" > results.json
          echo "results_file=results.json" >> $GITHUB_OUTPUT

          # Get status
          STATUS_RESPONSE=$(curl -sf \
            -H "X-API-Key: ${{ secrets.C2_API_KEY }}" \
            "$C2_URL/api/benchmark/$RUN_ID/status" || echo '{}')

          echo "$STATUS_RESPONSE" > status.json
          echo "status=$(echo "$STATUS_RESPONSE" | jq -r '.status // "unknown"')" >> $GITHUB_OUTPUT

      - name: Generate Results Summary
        if: success()
        run: |
          C2_URL="${{ steps.c2.outputs.c2_url }}"
          RUN_ID="${{ steps.start.outputs.run_id }}"
          MODE="${{ steps.mode.outputs.mode }}"

          # Generate markdown summary
          echo "## Benchmark Results - ${MODE^^} Mode" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Run ID:** \`$RUN_ID\`" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ steps.results.outputs.status }}" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "**C2:** PR-specific (PR #${{ github.event.pull_request.number }})" >> $GITHUB_STEP_SUMMARY
          else
            echo "**C2:** Main" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # Show worker placement info
          echo "### Worker Placement" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Architecture | Role | Instance Type | Region | AZ |" >> $GITHUB_STEP_SUMMARY
          echo "|--------------|------|---------------|--------|-----|" >> $GITHUB_STEP_SUMMARY

          # Fetch status to get worker info
          STATUS_RESPONSE=$(curl -sf \
            -H "X-API-Key: ${{ secrets.C2_API_KEY }}" \
            "$C2_URL/api/benchmark/$RUN_ID/status" || echo '{}')

          for arch in arm64 x86; do
            for role in server client; do
              KEY="${arch}-${role}"
              WORKER=$(echo "$STATUS_RESPONSE" | jq -r ".workers[\"$KEY\"] // {}")
              if [[ "$WORKER" != "{}" && "$WORKER" != "null" ]]; then
                W_TYPE=$(echo "$WORKER" | jq -r '.instance_type // "-"')
                W_REGION=$(echo "$WORKER" | jq -r '.region // "-"')
                W_AZ=$(echo "$WORKER" | jq -r '.az // "-"')
                echo "| $arch | $role | \`$W_TYPE\` | $W_REGION | $W_AZ |" >> $GITHUB_STEP_SUMMARY
              fi
            done
          done
          echo "" >> $GITHUB_STEP_SUMMARY

          for arch in arm64 x86; do
            ARCH_RESULTS=$(jq -r ".$arch // {}" results.json)
            ARCH_STATUS=$(echo "$ARCH_RESULTS" | jq -r '.status // "pending"')
            BENCHMARKS=$(echo "$ARCH_RESULTS" | jq -r '.benchmarks // []')
            COUNT=$(echo "$BENCHMARKS" | jq 'length')

            if [[ "$COUNT" -gt 0 ]]; then
              echo "### $arch Results" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "| Server | Req/sec | Avg Latency | P99 Latency | Errors |" >> $GITHUB_STEP_SUMMARY
              echo "|--------|---------|-------------|-------------|--------|" >> $GITHUB_STEP_SUMMARY

              echo "$BENCHMARKS" | jq -r '.[] | "| \(.server_type) | \(.requests_per_sec | floor) | \(.latency_avg / 1000000 | . * 100 | floor / 100)ms | \(.latency_p99 / 1000000 | . * 100 | floor / 100)ms | \(.errors) |"' >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
          done

      - name: Save Results for Commit
        if: |
          success() &&
          steps.mode.outputs.mode == 'metal' &&
          (github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && github.ref == 'refs/heads/main'))
        run: |
          # Save results to temp location before checkout overwrites workspace
          cp results.json /tmp/benchmark_results.json

      - name: Checkout Repository
        if: |
          success() &&
          steps.mode.outputs.mode == 'metal' &&
          (github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && github.ref == 'refs/heads/main'))
        uses: actions/checkout@v4
        with:
          ref: main
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Create PR with Benchmark Results
        if: |
          success() &&
          steps.mode.outputs.mode == 'metal' &&
          (github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && github.ref == 'refs/heads/main'))
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          RUN_ID="${{ steps.start.outputs.run_id }}"
          echo "Creating PR with metal results..."

          # Restore results from temp location
          cp /tmp/benchmark_results.json results.json

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Create branch name with tag and timestamp
          TAG="${{ github.event.release.tag_name }}"
          BRANCH="results/${TAG:-manual}-$(date +%Y%m%d%H%M%S)"

          git checkout -b "$BRANCH"

          # Determine result paths
          PATHS=("results/latest")
          if [[ "${{ github.event_name }}" == "release" ]]; then
            PATHS+=("results/$TAG")
          fi

          # Process each architecture
          ARM64_COUNT=0
          X86_COUNT=0
          for arch in arm64 x86; do
            ARCH_RESULTS=$(jq -r ".$arch // {}" results.json)
            BENCHMARKS=$(echo "$ARCH_RESULTS" | jq -r '.benchmarks // []')
            COUNT=$(echo "$BENCHMARKS" | jq 'length')

            if [[ "$arch" == "arm64" ]]; then
              ARM64_COUNT=$COUNT
            else
              X86_COUNT=$COUNT
            fi

            if [[ "$COUNT" -gt 0 ]]; then
              for path in "${PATHS[@]}"; do
                mkdir -p "$path/$arch"

                # Create results JSON with metadata
                jq -n \
                  --arg run_id "$RUN_ID" \
                  --arg arch "$arch" \
                  --arg mode "metal" \
                  --arg timestamp "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
                  --arg ref "${{ github.ref }}" \
                  --arg sha "${{ github.sha }}" \
                  --argjson benchmarks "$BENCHMARKS" \
                  '{
                    run_id: $run_id,
                    architecture: $arch,
                    mode: $mode,
                    timestamp: $timestamp,
                    git_ref: $ref,
                    git_sha: $sha,
                    benchmarks: $benchmarks
                  }' > "$path/$arch/results.json"

                git add "$path/$arch/results.json"
              done
            fi
          done

          # Commit and push if there are changes
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            COMMIT_MSG="chore: update benchmark results"
            if [[ "${{ github.event_name }}" == "release" ]]; then
              COMMIT_MSG="chore: add benchmark results for $TAG"
            fi
            git commit -m "$COMMIT_MSG"
            git push -u origin "$BRANCH"

            # Create PR body with results summary
            PR_BODY="Automated benchmark results from run \`$RUN_ID\`.

## Results
- ARM64: $ARM64_COUNT benchmarks
- x86: $X86_COUNT benchmarks

**Please review the results before merging.**"

            # Create PR (no auto-merge)
            PR_TITLE="$COMMIT_MSG"
            PR_URL=$(gh pr create \
              --title "$PR_TITLE" \
              --body "$PR_BODY" \
              --base main)

            echo "::notice::Results PR created: $PR_URL"
            echo "Results PR created successfully: $PR_URL"
          fi

      - name: Post PR Comment with Results
        if: |
          success() &&
          github.event_name == 'pull_request'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          C2_URL="${{ steps.c2.outputs.c2_url }}"
          RUN_ID="${{ steps.start.outputs.run_id }}"
          MODE="${{ steps.mode.outputs.mode }}"
          PR_NUMBER="${{ github.event.pull_request.number }}"

          # Fetch status to get worker info
          STATUS_RESPONSE=$(curl -sf \
            -H "X-API-Key: ${{ secrets.C2_API_KEY }}" \
            "$C2_URL/api/benchmark/$RUN_ID/status" || echo '{}')

          # Build comment body
          COMMENT="## Benchmark Results - ${MODE^^} Mode\n\n"
          COMMENT+="**Run ID:** \`$RUN_ID\`\n"
          COMMENT+="**Status:** ${{ steps.results.outputs.status }}\n"
          COMMENT+="**C2:** PR-specific (built from this PR's code)\n\n"

          # Add worker placement info
          COMMENT+="### Worker Placement\n\n"
          COMMENT+="| Architecture | Role | Instance Type | Region | AZ |\n"
          COMMENT+="|--------------|------|---------------|--------|-----|\n"

          for arch in arm64 x86; do
            for role in server client; do
              KEY="${arch}-${role}"
              WORKER=$(echo "$STATUS_RESPONSE" | jq -r ".workers[\"$KEY\"] // {}")
              if [[ "$WORKER" != "{}" && "$WORKER" != "null" ]]; then
                W_TYPE=$(echo "$WORKER" | jq -r '.instance_type // "-"')
                W_REGION=$(echo "$WORKER" | jq -r '.region // "-"')
                W_AZ=$(echo "$WORKER" | jq -r '.az // "-"')
                COMMENT+="| $arch | $role | \`$W_TYPE\` | $W_REGION | $W_AZ |\n"
              fi
            done
          done
          COMMENT+="\n"

          for arch in arm64 x86; do
            ARCH_RESULTS=$(jq -r ".$arch // {}" results.json)
            BENCHMARKS=$(echo "$ARCH_RESULTS" | jq -r '.benchmarks // []')
            COUNT=$(echo "$BENCHMARKS" | jq 'length')

            if [[ "$COUNT" -gt 0 ]]; then
              COMMENT+="### $arch Results\n\n"
              COMMENT+="| Server | Req/sec | Avg Latency | P99 Latency | Errors |\n"
              COMMENT+="|--------|---------|-------------|-------------|--------|\n"

              while IFS= read -r row; do
                COMMENT+="$row\n"
              done < <(echo "$BENCHMARKS" | jq -r '.[] | "| \(.server_type) | \(.requests_per_sec | floor) | \(.latency_avg / 1000000 | . * 100 | floor / 100)ms | \(.latency_p99 / 1000000 | . * 100 | floor / 100)ms | \(.errors) |"')

              COMMENT+="\n"
            fi
          done

          # Delete previous benchmark comments (if any)
          gh api "repos/${{ github.repository }}/issues/${PR_NUMBER}/comments" \
            --jq '.[] | select(.user.login == "github-actions[bot]" and (.body | contains("Benchmark Results"))) | .id' \
            | xargs -I {} gh api -X DELETE "repos/${{ github.repository }}/issues/comments/{}" 2>/dev/null || true

          # Post new comment
          echo -e "$COMMENT" | gh pr comment "$PR_NUMBER" --body-file -
          echo "Posted results to PR #$PR_NUMBER"

      - name: Get Results Summary (Fallback)
        if: failure()
        run: |
          C2_URL="${{ steps.c2.outputs.c2_url }}"
          RUN_ID="${{ steps.start.outputs.run_id }}"
          if [[ -z "$RUN_ID" ]]; then
            echo "No run ID available"
            exit 0
          fi

          RESPONSE=$(curl -sf \
            -H "X-API-Key: ${{ secrets.C2_API_KEY }}" \
            "$C2_URL/api/benchmark/$RUN_ID/status" || echo '{}')

          echo "## Benchmark Results (Partial)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Run ID:** $RUN_ID" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** $(echo "$RESPONSE" | jq -r '.status // "unknown"')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Error:** $(echo "$RESPONSE" | jq -r '.error // "Benchmark did not complete successfully"')" >> $GITHUB_STEP_SUMMARY

      - name: Cancel Benchmark on Workflow Cancellation
        if: cancelled()
        run: |
          C2_URL="${{ steps.c2.outputs.c2_url }}"
          RUN_ID="${{ steps.start.outputs.run_id }}"
          if [[ -z "$RUN_ID" ]]; then
            echo "No run ID to cancel"
            exit 0
          fi

          echo "Workflow cancelled - sending cancel request to C2 for run $RUN_ID..."

          RESPONSE=$(curl -sf -X POST \
            -H "X-API-Key: ${{ secrets.C2_API_KEY }}" \
            "$C2_URL/api/benchmark/$RUN_ID/cancel" || echo '{"error":"failed to cancel"}')

          echo "Cancel response: $RESPONSE"

          # Also add to summary
          echo "## Benchmark Cancelled" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Run ID:** $RUN_ID" >> $GITHUB_STEP_SUMMARY
          echo "Benchmark was cancelled. Workers are being terminated." >> $GITHUB_STEP_SUMMARY

  # Cleanup PR C2 after benchmark completes (success or failure)
  cleanup-pr-c2:
    name: Cleanup PR C2
    runs-on: ubuntu-latest
    needs: [deploy-pr-c2, benchmark]
    if: |
      always() &&
      github.event_name == 'pull_request' &&
      needs.deploy-pr-c2.result == 'success'

    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Delete PR C2 Stack
        run: |
          STACK_NAME="${{ needs.deploy-pr-c2.outputs.stack_name }}"
          echo "Deleting PR C2 stack: $STACK_NAME"

          aws cloudformation delete-stack --stack-name "$STACK_NAME"
          echo "Stack deletion initiated"

          # Wait for deletion (with timeout)
          echo "Waiting for stack deletion..."
          aws cloudformation wait stack-delete-complete --stack-name "$STACK_NAME" || true

          echo "PR C2 cleanup complete"

      - name: Cleanup S3 Artifacts
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          BUCKET="celeris-artifacts-${{ secrets.AWS_ACCOUNT_ID }}"

          echo "Cleaning up S3 artifacts for PR #$PR_NUMBER..."
          aws s3 rm "s3://${BUCKET}/pr-c2/pr-${PR_NUMBER}/" --recursive || true
          echo "S3 cleanup complete"
