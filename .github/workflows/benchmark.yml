name: Benchmark

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      mode:
        description: 'Benchmark mode'
        required: false
        type: choice
        options:
          - fast
          - med
          - metal
        default: fast
      duration:
        description: 'Benchmark duration (e.g., 10s, 30s, 60s)'
        required: false
        default: ''
      bench_mode:
        description: 'Servers to benchmark'
        required: false
        type: choice
        options:
          - all
          - baseline
          - theoretical
        default: all

env:
  AWS_REGION: us-east-1

jobs:
  benchmark:
    name: Run Benchmark
    runs-on: ubuntu-latest
    timeout-minutes: 240
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Determine Benchmark Mode
        id: mode
        run: |
          if [[ "${{ github.event_name }}" == "release" ]]; then
            echo "mode=metal" >> $GITHUB_OUTPUT
            echo "Running METAL benchmarks for release"
          else
            echo "mode=${{ inputs.mode || 'fast' }}" >> $GITHUB_OUTPUT
            echo "Running ${{ inputs.mode || 'fast' }} benchmarks (manual trigger)"
          fi

      - name: Start Benchmark
        id: start
        run: |
          C2_URL="${{ secrets.C2_URL }}"
          echo "Starting benchmark (mode: ${{ steps.mode.outputs.mode }}) against $C2_URL"

          PARAMS="mode=${{ steps.mode.outputs.mode }}"
          if [[ -n "${{ inputs.duration }}" ]]; then
            PARAMS="$PARAMS&duration=${{ inputs.duration }}"
          fi
          if [[ -n "${{ inputs.bench_mode }}" ]]; then
            PARAMS="$PARAMS&bench_mode=${{ inputs.bench_mode }}"
          fi

          RESPONSE=$(curl -sf -X POST \
            -H "X-API-Key: ${{ secrets.C2_API_KEY }}" \
            "$C2_URL/api/benchmark/start?$PARAMS")

          RUN_ID=$(echo "$RESPONSE" | jq -r '.run_id')
          if [[ -z "$RUN_ID" || "$RUN_ID" == "null" ]]; then
            echo "::error::Failed to start benchmark: $RESPONSE"
            exit 1
          fi

          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT
          echo "Benchmark started: $RUN_ID"

      - name: Wait for Completion
        run: |
          C2_URL="${{ secrets.C2_URL }}"
          RUN_ID="${{ steps.start.outputs.run_id }}"
          echo "Waiting for benchmark $RUN_ID to complete..."

          POLL_INTERVAL=30
          MAX_WAIT=14400
          ELAPSED=0
          LAST_QUEUE_POS=0
          PLACEMENT_SHOWN=false

          while [ $ELAPSED -lt $MAX_WAIT ]; do
            RESPONSE=$(curl -sf \
              -H "X-API-Key: ${{ secrets.C2_API_KEY }}" \
              "$C2_URL/api/benchmark/$RUN_ID/status" || echo '{"status":"unknown"}')

            STATUS=$(echo "$RESPONSE" | jq -r '.status')

            case $STATUS in
              completed)
                echo "Benchmark completed successfully!"
                exit 0
                ;;
              failed|cancelled)
                ERROR=$(echo "$RESPONSE" | jq -r '.error // "Unknown error"')
                echo "::error::Benchmark failed: $ERROR"
                exit 1
                ;;
              queued)
                QUEUE_POS=$(echo "$RESPONSE" | jq -r '.queue_position // 0')
                if [[ "$QUEUE_POS" != "$LAST_QUEUE_POS" ]]; then
                  echo "[$((ELAPSED/60))m] Queued - position $QUEUE_POS (waiting for capacity)"
                  LAST_QUEUE_POS=$QUEUE_POS
                fi
                ;;
              pending|running)
                if [[ "$PLACEMENT_SHOWN" == "false" ]]; then
                  WORKERS=$(echo "$RESPONSE" | jq -c '.workers // {}')
                  if [[ "$WORKERS" != "{}" ]]; then
                    WORKER_COUNT=$(echo "$WORKERS" | jq 'keys | length')
                    if [[ "$WORKER_COUNT" -gt 0 ]]; then
                      echo ""
                      echo "=== Worker Placement ==="
                      for arch in arm64 x86; do
                        for role in server client; do
                          KEY="${arch}-${role}"
                          WORKER=$(echo "$RESPONSE" | jq -r ".workers[\"$KEY\"] // {}")
                          if [[ "$WORKER" != "{}" && "$WORKER" != "null" ]]; then
                            W_TYPE=$(echo "$WORKER" | jq -r '.instance_type // "unknown"')
                            W_REGION=$(echo "$WORKER" | jq -r '.region // "unknown"')
                            W_AZ=$(echo "$WORKER" | jq -r '.az // "unknown"')
                            echo "  $arch $role: $W_TYPE in $W_REGION ($W_AZ)"
                          fi
                        done
                      done
                      echo "========================="
                      echo ""
                      PLACEMENT_SHOWN=true
                    fi
                  fi
                fi
                echo "[$((ELAPSED/60))m] Status: $STATUS"
                WORKERS=$(echo "$RESPONSE" | jq -c '.workers // {}')
                if [[ "$WORKERS" != "{}" ]]; then
                  for arch in arm64 x86; do
                    CLIENT_KEY="${arch}-client"
                    CLIENT=$(echo "$RESPONSE" | jq -r ".workers[\"$CLIENT_KEY\"] // {}")
                    if [[ "$CLIENT" != "{}" && "$CLIENT" != "null" ]]; then
                      CURRENT_SERVER=$(echo "$CLIENT" | jq -r '.current_server // ""')
                      CURRENT_BENCH=$(echo "$CLIENT" | jq -r '.current_benchmark // ""')
                      CURRENT_COUNT=$(echo "$CLIENT" | jq -r '.current_count // 0')
                      TOTAL_COUNT=$(echo "$CLIENT" | jq -r '.total_count // 0')
                      if [[ -n "$CURRENT_SERVER" && -n "$CURRENT_BENCH" && "$TOTAL_COUNT" -gt 0 ]]; then
                        echo "  $arch: Testing $CURRENT_SERVER/$CURRENT_BENCH ($CURRENT_COUNT/$TOTAL_COUNT)"
                      fi
                    fi
                  done
                fi
                ;;
              *)
                echo "[$((ELAPSED/60))m] Unknown status: $STATUS"
                ;;
            esac

            sleep $POLL_INTERVAL
            ELAPSED=$((ELAPSED + POLL_INTERVAL))
          done

          echo "::error::Timeout waiting for benchmark completion"
          exit 1

      - name: Get Full Results
        id: results
        if: success()
        run: |
          C2_URL="${{ secrets.C2_URL }}"
          RUN_ID="${{ steps.start.outputs.run_id }}"
          if [[ -z "$RUN_ID" ]]; then
            echo "No run ID available"
            exit 0
          fi

          RESULTS=$(curl -sf \
            -H "X-API-Key: ${{ secrets.C2_API_KEY }}" \
            "$C2_URL/api/benchmark/$RUN_ID/results" || echo '{}')

          echo "$RESULTS" > results.json
          echo "results_file=results.json" >> $GITHUB_OUTPUT

          STATUS_RESPONSE=$(curl -sf \
            -H "X-API-Key: ${{ secrets.C2_API_KEY }}" \
            "$C2_URL/api/benchmark/$RUN_ID/status" || echo '{}')

          echo "$STATUS_RESPONSE" > status.json
          echo "status=$(echo "$STATUS_RESPONSE" | jq -r '.status // "unknown"')" >> $GITHUB_OUTPUT

      - name: Generate Results Summary
        if: success()
        run: |
          C2_URL="${{ secrets.C2_URL }}"
          RUN_ID="${{ steps.start.outputs.run_id }}"
          MODE="${{ steps.mode.outputs.mode }}"

          echo "## Benchmark Results - ${MODE^^} Mode" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Run ID:** \`$RUN_ID\`" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ steps.results.outputs.status }}" >> $GITHUB_STEP_SUMMARY
          echo "**C2:** Main" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Worker Placement" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Architecture | Role | Instance Type | Region | AZ |" >> $GITHUB_STEP_SUMMARY
          echo "|--------------|------|---------------|--------|-----|" >> $GITHUB_STEP_SUMMARY

          STATUS_RESPONSE=$(curl -sf \
            -H "X-API-Key: ${{ secrets.C2_API_KEY }}" \
            "$C2_URL/api/benchmark/$RUN_ID/status" || echo '{}')

          for arch in arm64 x86; do
            for role in server client; do
              KEY="${arch}-${role}"
              WORKER=$(echo "$STATUS_RESPONSE" | jq -r ".workers[\"$KEY\"] // {}")
              if [[ "$WORKER" != "{}" && "$WORKER" != "null" ]]; then
                W_TYPE=$(echo "$WORKER" | jq -r '.instance_type // "-"')
                W_REGION=$(echo "$WORKER" | jq -r '.region // "-"')
                W_AZ=$(echo "$WORKER" | jq -r '.az // "-"')
                echo "| $arch | $role | \`$W_TYPE\` | $W_REGION | $W_AZ |" >> $GITHUB_STEP_SUMMARY
              fi
            done
          done
          echo "" >> $GITHUB_STEP_SUMMARY

          for arch in arm64 x86; do
            ARCH_RESULTS=$(jq -r ".$arch // {}" results.json)
            BENCHMARKS=$(echo "$ARCH_RESULTS" | jq -r '.benchmarks // []')
            COUNT=$(echo "$BENCHMARKS" | jq 'length')

            if [[ "$COUNT" -gt 0 ]]; then
              echo "### $arch Results" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "| Server | Req/sec | Avg Latency | P99 Latency | Errors |" >> $GITHUB_STEP_SUMMARY
              echo "|--------|---------|-------------|-------------|--------|" >> $GITHUB_STEP_SUMMARY

              echo "$BENCHMARKS" | jq -r '.[] | "| \(.server_type) | \(.requests_per_sec | floor) | \(.latency_avg / 1000000 | . * 100 | floor / 100)ms | \(.latency_p99 / 1000000 | . * 100 | floor / 100)ms | \(.errors) |"' >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
          done

      - name: Save Results for Commit
        if: success() && steps.mode.outputs.mode == 'metal' && (github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && github.ref == 'refs/heads/main'))
        run: |
          cp results.json /tmp/benchmark_results.json

      - name: Checkout Repository
        if: success() && steps.mode.outputs.mode == 'metal' && (github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && github.ref == 'refs/heads/main'))
        uses: actions/checkout@v4
        with:
          ref: main
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Create PR with Benchmark Results
        if: success() && steps.mode.outputs.mode == 'metal' && (github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && github.ref == 'refs/heads/main'))
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          RUN_ID="${{ steps.start.outputs.run_id }}"
          echo "Creating PR with metal results..."

          cp /tmp/benchmark_results.json results.json

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          TAG="${{ github.event.release.tag_name }}"
          BRANCH="results/${TAG:-manual}-$(date +%Y%m%d%H%M%S)"

          git checkout -b "$BRANCH"

          PATHS=("results/latest")
          if [[ "${{ github.event_name }}" == "release" ]]; then
            PATHS+=("results/$TAG")
          fi

          ARM64_COUNT=0
          X86_COUNT=0
          for arch in arm64 x86; do
            ARCH_RESULTS=$(jq -r ".$arch // {}" results.json)
            BENCHMARKS=$(echo "$ARCH_RESULTS" | jq -r '.benchmarks // []')
            COUNT=$(echo "$BENCHMARKS" | jq 'length')

            if [[ "$arch" == "arm64" ]]; then
              ARM64_COUNT=$COUNT
            else
              X86_COUNT=$COUNT
            fi

            if [[ "$COUNT" -gt 0 ]]; then
              for path in "${PATHS[@]}"; do
                mkdir -p "$path/$arch"

                jq -n \
                  --arg run_id "$RUN_ID" \
                  --arg arch "$arch" \
                  --arg mode "metal" \
                  --arg timestamp "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
                  --arg ref "${{ github.ref }}" \
                  --arg sha "${{ github.sha }}" \
                  --argjson benchmarks "$BENCHMARKS" \
                  '{
                    run_id: $run_id,
                    architecture: $arch,
                    mode: $mode,
                    timestamp: $timestamp,
                    git_ref: $ref,
                    git_sha: $sha,
                    benchmarks: $benchmarks
                  }' > "$path/$arch/results.json"

                git add "$path/$arch/results.json"
              done
            fi
          done

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            COMMIT_MSG="chore: update benchmark results"
            if [[ "${{ github.event_name }}" == "release" ]]; then
              COMMIT_MSG="chore: add benchmark results for $TAG"
            fi
            git commit -m "$COMMIT_MSG"
            git push -u origin "$BRANCH"

            PR_TITLE="$COMMIT_MSG"
            PR_URL=$(gh pr create \
              --title "$PR_TITLE" \
              --body "Automated benchmark results from run \`$RUN_ID\`.\n\n## Results\n- ARM64: $ARM64_COUNT benchmarks\n- x86: $X86_COUNT benchmarks\n\n**Please review the results before merging.**" \
              --base main)

            echo "::notice::Results PR created: $PR_URL"
            echo "Results PR created successfully: $PR_URL"
          fi

      - name: Get Results Summary (Fallback)
        if: failure()
        run: |
          C2_URL="${{ secrets.C2_URL }}"
          RUN_ID="${{ steps.start.outputs.run_id }}"
          if [[ -z "$RUN_ID" ]]; then
            echo "No run ID available"
            exit 0
          fi

          RESPONSE=$(curl -sf \
            -H "X-API-Key: ${{ secrets.C2_API_KEY }}" \
            "$C2_URL/api/benchmark/$RUN_ID/status" || echo '{}')

          echo "## Benchmark Results (Partial)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Run ID:** $RUN_ID" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** $(echo "$RESPONSE" | jq -r '.status // "unknown"')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Error:** $(echo "$RESPONSE" | jq -r '.error // "Benchmark did not complete successfully"')" >> $GITHUB_STEP_SUMMARY

      - name: Cancel Benchmark on Workflow Cancellation
        if: cancelled()
        run: |
          C2_URL="${{ secrets.C2_URL }}"
          RUN_ID="${{ steps.start.outputs.run_id }}"
          if [[ -z "$RUN_ID" ]]; then
            echo "No run ID to cancel"
            exit 0
          fi

          echo "Workflow cancelled - sending cancel request to C2 for run $RUN_ID..."

          RESPONSE=$(curl -sf -X POST \
            -H "X-API-Key: ${{ secrets.C2_API_KEY }}" \
            "$C2_URL/api/benchmark/$RUN_ID/cancel" || echo '{"error":"failed to cancel"}')

          echo "Cancel response: $RESPONSE"

          echo "## Benchmark Cancelled" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Run ID:** $RUN_ID" >> $GITHUB_STEP_SUMMARY
          echo "Benchmark was cancelled. Workers are being terminated." >> $GITHUB_STEP_SUMMARY
