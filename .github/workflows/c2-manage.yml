name: Manage C2

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - status
          - restart
          - logs
          - cleanup
        default: status
      lines:
        description: 'Number of log lines (for logs action)'
        required: false
        default: '100'

env:
  AWS_REGION: us-east-1

jobs:
  manage:
    name: Manage C2
    runs-on: ubuntu-latest

    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get C2 Instance
        id: instance
        run: |
          INSTANCE_ID=$(aws ec2 describe-instances \
            --filters "Name=tag:Name,Values=celeris-c2" \
                      "Name=instance-state-name,Values=running" \
            --query 'Reservations[0].Instances[0].InstanceId' \
            --output text)

          if [[ -z "$INSTANCE_ID" || "$INSTANCE_ID" == "None" ]]; then
            echo "::error::C2 instance not found"
            exit 1
          fi

          PUBLIC_IP=$(aws ec2 describe-instances \
            --instance-ids "$INSTANCE_ID" \
            --query 'Reservations[0].Instances[0].PublicIpAddress' \
            --output text)

          echo "instance_id=$INSTANCE_ID" >> $GITHUB_OUTPUT
          echo "public_ip=$PUBLIC_IP" >> $GITHUB_OUTPUT
          echo "Found C2 instance: $INSTANCE_ID ($PUBLIC_IP)"

      - name: Status
        if: inputs.action == 'status'
        run: |
          echo "## C2 Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Instance status
          echo "### Instance" >> $GITHUB_STEP_SUMMARY
          echo "- Instance ID: ${{ steps.instance.outputs.instance_id }}" >> $GITHUB_STEP_SUMMARY
          echo "- Public IP: ${{ steps.instance.outputs.public_ip }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Service status via SSM
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "${{ steps.instance.outputs.instance_id }}" \
            --document-name "AWS-RunShellScript" \
            --parameters 'commands=["systemctl status c2 --no-pager", "df -h /data", "uptime"]' \
            --output text --query 'Command.CommandId')

          sleep 10

          OUTPUT=$(aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "${{ steps.instance.outputs.instance_id }}" \
            --query 'StandardOutputContent' --output text 2>/dev/null || echo "Failed to get status")

          echo "### Service Status" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "$OUTPUT" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

          # API health
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### API Health" >> $GITHUB_STEP_SUMMARY
          if curl -sf "http://${{ steps.instance.outputs.public_ip }}:8080/health" > /dev/null 2>&1; then
            echo "API is healthy" >> $GITHUB_STEP_SUMMARY
          else
            echo "API health check failed" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Restart
        if: inputs.action == 'restart'
        run: |
          echo "Restarting C2 service..."

          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "${{ steps.instance.outputs.instance_id }}" \
            --document-name "AWS-RunShellScript" \
            --parameters 'commands=["systemctl restart c2", "sleep 5", "systemctl status c2 --no-pager"]' \
            --output text --query 'Command.CommandId')

          sleep 15

          STATUS=$(aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "${{ steps.instance.outputs.instance_id }}" \
            --query 'Status' --output text 2>/dev/null || echo "Unknown")

          echo "Command status: $STATUS"

          if [[ "$STATUS" == "Success" ]]; then
            echo "C2 restarted successfully"

            # Verify health
            sleep 10
            if curl -sf "http://${{ steps.instance.outputs.public_ip }}:8080/health" > /dev/null 2>&1; then
              echo "C2 is healthy after restart"
            else
              echo "::warning::C2 health check failed after restart"
            fi
          else
            echo "::error::Failed to restart C2"
            exit 1
          fi

      - name: Logs
        if: inputs.action == 'logs'
        run: |
          echo "Fetching last ${{ inputs.lines }} lines of C2 logs..."

          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "${{ steps.instance.outputs.instance_id }}" \
            --document-name "AWS-RunShellScript" \
            --parameters "commands=[\"tail -n ${{ inputs.lines }} /data/logs/c2.log\"]" \
            --output text --query 'Command.CommandId')

          sleep 10

          OUTPUT=$(aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "${{ steps.instance.outputs.instance_id }}" \
            --query 'StandardOutputContent' --output text 2>/dev/null || echo "Failed to get logs")

          echo "## C2 Logs (last ${{ inputs.lines }} lines)" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "$OUTPUT" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Cleanup Orphaned Resources
        if: inputs.action == 'cleanup'
        run: |
          echo "## Cleanup Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Find orphaned worker instances
          echo "### Orphaned Worker Instances" >> $GITHUB_STEP_SUMMARY
          WORKERS=$(aws ec2 describe-instances \
            --filters "Name=tag:Project,Values=celeris-benchmarks" \
                      "Name=tag:Name,Values=celeris-server-*,celeris-client-*" \
                      "Name=instance-state-name,Values=running,pending" \
            --query 'Reservations[].Instances[].[InstanceId,Tags[?Key==`Name`].Value|[0],LaunchTime]' \
            --output text)

          if [[ -z "$WORKERS" ]]; then
            echo "No orphaned workers found" >> $GITHUB_STEP_SUMMARY
          else
            echo "Found orphaned workers:" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "$WORKERS" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY

            # Terminate them
            INSTANCE_IDS=$(echo "$WORKERS" | awk '{print $1}' | tr '\n' ' ')
            if [[ -n "$INSTANCE_IDS" ]]; then
              echo "Terminating: $INSTANCE_IDS"
              aws ec2 terminate-instances --instance-ids $INSTANCE_IDS
              echo "Terminated orphaned instances" >> $GITHUB_STEP_SUMMARY
            fi
          fi

          # Find orphaned CloudFormation stacks
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Orphaned Worker Stacks" >> $GITHUB_STEP_SUMMARY
          STACKS=$(aws cloudformation list-stacks \
            --stack-status-filter CREATE_COMPLETE UPDATE_COMPLETE \
            --query 'StackSummaries[?starts_with(StackName, `celeris-workers-`)].StackName' \
            --output text)

          if [[ -z "$STACKS" ]]; then
            echo "No orphaned stacks found" >> $GITHUB_STEP_SUMMARY
          else
            echo "Found orphaned stacks:" >> $GITHUB_STEP_SUMMARY
            for stack in $STACKS; do
              echo "- Deleting $stack"
              aws cloudformation delete-stack --stack-name "$stack"
            done
            echo "Deleted orphaned stacks" >> $GITHUB_STEP_SUMMARY
          fi
