name: Cleanup Instances

# Emergency cleanup workflow to terminate all benchmark instances
# Use this if instances are orphaned or to reset the environment

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (list instances without terminating)'
        required: false
        default: 'false'
        type: boolean
      instance_filter:
        description: 'Filter instances to cleanup'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - arm64-only
          - x86-only
          - spot-only
          - ondemand-only

env:
  AWS_REGION: us-east-1

jobs:
  cleanup:
    name: Cleanup Benchmark Instances
    runs-on: ubuntu-latest

    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: List All Benchmark Instances
        id: list
        run: |
          echo "## Current Benchmark Instances" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Find all instances with benchmark-runner in the name
          INSTANCES=$(aws ec2 describe-instances \
            --filters "Name=tag:Name,Values=benchmark-runner-*" \
                      "Name=instance-state-name,Values=pending,running,stopping,stopped" \
            --query 'Reservations[].Instances[].[InstanceId,InstanceType,State.Name,LaunchTime,Tags[?Key==`Name`].Value|[0],Tags[?Key==`Architecture`].Value|[0],Tags[?Key==`Mode`].Value|[0]]' \
            --output text)

          if [ -z "$INSTANCES" ]; then
            echo "No benchmark instances found." >> $GITHUB_STEP_SUMMARY
            echo "instances_found=false" >> $GITHUB_OUTPUT
          else
            echo "| Instance ID | Type | State | Launched | Name | Arch | Mode |" >> $GITHUB_STEP_SUMMARY
            echo "|-------------|------|-------|----------|------|------|------|" >> $GITHUB_STEP_SUMMARY
            echo "$INSTANCES" | while read id type state launched name arch mode; do
              echo "| $id | $type | $state | $launched | $name | $arch | $mode |" >> $GITHUB_STEP_SUMMARY
            done
            echo "instances_found=true" >> $GITHUB_OUTPUT
          fi

          # Also list spot instance requests
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Spot Instance Requests" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          SPOTS=$(aws ec2 describe-spot-instance-requests \
            --filters "Name=state,Values=open,active" \
            --query 'SpotInstanceRequests[].[SpotInstanceRequestId,InstanceId,State,LaunchSpecification.InstanceType]' \
            --output text 2>/dev/null || echo "")

          if [ -z "$SPOTS" ]; then
            echo "No active spot instance requests." >> $GITHUB_STEP_SUMMARY
          else
            echo "| Request ID | Instance ID | State | Type |" >> $GITHUB_STEP_SUMMARY
            echo "|------------|-------------|-------|------|" >> $GITHUB_STEP_SUMMARY
            echo "$SPOTS" | while read rid iid state type; do
              echo "| $rid | $iid | $state | $type |" >> $GITHUB_STEP_SUMMARY
            done
          fi

      - name: Build Instance Filter
        id: filter
        if: steps.list.outputs.instances_found == 'true'
        run: |
          FILTER="${{ github.event.inputs.instance_filter }}"

          case "$FILTER" in
            arm64-only)
              echo "tag_filter=Name=tag:Architecture,Values=arm64" >> $GITHUB_OUTPUT
              ;;
            x86-only)
              echo "tag_filter=Name=tag:Architecture,Values=x86_64" >> $GITHUB_OUTPUT
              ;;
            spot-only)
              echo "tag_filter=Name=instance-lifecycle,Values=spot" >> $GITHUB_OUTPUT
              ;;
            ondemand-only)
              # On-demand instances don't have the instance-lifecycle tag
              echo "tag_filter=" >> $GITHUB_OUTPUT
              echo "exclude_spot=true" >> $GITHUB_OUTPUT
              ;;
            *)
              echo "tag_filter=" >> $GITHUB_OUTPUT
              ;;
          esac

      - name: Terminate Instances
        if: steps.list.outputs.instances_found == 'true' && github.event.inputs.dry_run == 'false'
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Termination Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          FILTER="${{ github.event.inputs.instance_filter }}"

          # Build the filter command
          FILTERS="Name=tag:Name,Values=benchmark-runner-* Name=instance-state-name,Values=pending,running,stopping,stopped"

          if [ "$FILTER" == "arm64-only" ]; then
            FILTERS="$FILTERS Name=tag:Architecture,Values=arm64"
          elif [ "$FILTER" == "x86-only" ]; then
            FILTERS="$FILTERS Name=tag:Architecture,Values=x86_64"
          fi

          # Get instance IDs
          INSTANCE_IDS=$(aws ec2 describe-instances \
            --filters $FILTERS \
            --query 'Reservations[].Instances[].InstanceId' \
            --output text)

          if [ -z "$INSTANCE_IDS" ]; then
            echo "No instances match the filter criteria." >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

          # Filter by spot/on-demand if needed
          if [ "$FILTER" == "spot-only" ]; then
            INSTANCE_IDS=$(aws ec2 describe-instances \
              --instance-ids $INSTANCE_IDS \
              --query 'Reservations[].Instances[?InstanceLifecycle==`spot`].InstanceId' \
              --output text)
          elif [ "$FILTER" == "ondemand-only" ]; then
            INSTANCE_IDS=$(aws ec2 describe-instances \
              --instance-ids $INSTANCE_IDS \
              --query 'Reservations[].Instances[?InstanceLifecycle!=`spot`].InstanceId' \
              --output text)
          fi

          if [ -z "$INSTANCE_IDS" ]; then
            echo "No instances match the filter criteria after lifecycle filter." >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

          echo "Terminating instances: $INSTANCE_IDS"
          aws ec2 terminate-instances --instance-ids $INSTANCE_IDS

          echo "Terminated: $INSTANCE_IDS" >> $GITHUB_STEP_SUMMARY

      - name: Cancel Spot Requests
        if: steps.list.outputs.instances_found == 'true' && github.event.inputs.dry_run == 'false'
        run: |
          # Cancel any open spot instance requests
          SPOT_IDS=$(aws ec2 describe-spot-instance-requests \
            --filters "Name=state,Values=open,active" \
            --query 'SpotInstanceRequests[].SpotInstanceRequestId' \
            --output text 2>/dev/null || echo "")

          if [ -n "$SPOT_IDS" ]; then
            echo "Cancelling spot requests: $SPOT_IDS"
            aws ec2 cancel-spot-instance-requests --spot-instance-request-ids $SPOT_IDS
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Cancelled spot requests: $SPOT_IDS" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Dry Run Notice
        if: github.event.inputs.dry_run == 'true'
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "**DRY RUN**: No instances were terminated. Run again with dry_run=false to actually terminate." >> $GITHUB_STEP_SUMMARY

      - name: Deregister Offline Runners
        if: github.event.inputs.dry_run == 'false'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT_RUNNER_TOKEN }}
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Runner Cleanup" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # List offline self-hosted runners
          RUNNERS=$(gh api repos/${{ github.repository }}/actions/runners --jq '.runners[] | select(.status == "offline") | "\(.id) \(.name)"')

          if [ -z "$RUNNERS" ]; then
            echo "No offline runners to remove." >> $GITHUB_STEP_SUMMARY
          else
            echo "$RUNNERS" | while read id name; do
              echo "Removing offline runner: $name (ID: $id)"
              gh api -X DELETE repos/${{ github.repository }}/actions/runners/$id || true
              echo "Removed runner: $name" >> $GITHUB_STEP_SUMMARY
            done
          fi
