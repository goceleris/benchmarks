name: Benchmark (Fast)

# Fast mode: Runs on PRs for quick trend validation
# Uses cheaper virtualized instances (c5.large, c6g.medium)

on:
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      duration:
        description: 'Benchmark duration (e.g., 15s, 30s)'
        required: false
        default: '15s'
      benchmark_mode:
        description: 'Benchmark servers to test'
        required: false
        default: 'baseline'
        type: choice
        options:
          - baseline
          - theoretical
          - all

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

env:
  TF_VAR_repository_url: ${{ github.server_url }}/${{ github.repository }}
  TF_VAR_benchmark_mode: fast

jobs:
  # ============================================================
  # Phase 1: Launch Fast Infrastructure
  # ============================================================
  launch:
    name: Launch Fast Infrastructure
    runs-on: ubuntu-latest
    outputs:
      arm64_launched: ${{ steps.apply.outputs.arm64_launched }}
      x86_launched: ${{ steps.apply.outputs.x86_launched }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.6.0"
      
      - name: Terraform Init
        working-directory: terraform
        run: terraform init
      
      - name: Terraform Apply (Fast Mode)
        id: apply
        working-directory: terraform
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          TF_VAR_gh_pat_runner_token: ${{ secrets.GH_PAT_RUNNER_TOKEN }}
        run: |
          echo "üöÄ Launching FAST benchmark infrastructure (c5.large, c6g.medium)"
          terraform apply -auto-approve
          
          echo "arm64_launched=true" >> $GITHUB_OUTPUT
          echo "x86_launched=true" >> $GITHUB_OUTPUT
      
      - name: Wait for Runners
        run: |
          echo "Waiting for fast runners to register (60s)..."
          sleep 60

  # ============================================================
  # Phase 2: Fast Benchmark (ARM64)
  # ============================================================
  benchmark-arm64:
    name: Fast Benchmark (ARM64)
    needs: launch
    runs-on: [self-hosted, fast-arm64]
    timeout-minutes: 30
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'
      
      - name: Build Server and Benchmark Tool
        run: |
          go mod download
          go build -o bin/server ./cmd/server
          go build -o bin/bench ./cmd/bench
      
      - name: Run Benchmarks
        env:
          BENCHMARK_DURATION: ${{ github.event.inputs.duration || '15s' }}
          BENCHMARK_MODE: ${{ github.event.inputs.benchmark_mode || 'baseline' }}
        run: |
          ./bin/bench -mode "$BENCHMARK_MODE" -duration "$BENCHMARK_DURATION" -connections 128 -workers 4
      
      - name: Upload Results
        uses: actions/upload-artifact@v4
        with:
          name: fast-results-arm64
          path: results/
          retention-days: 7

  # ============================================================
  # Phase 2: Fast Benchmark (x86)
  # ============================================================
  benchmark-x86:
    name: Fast Benchmark (x86)
    needs: launch
    runs-on: [self-hosted, fast-x86]
    timeout-minutes: 30
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'
      
      - name: Build Server and Benchmark Tool
        run: |
          go mod download
          go build -o bin/server ./cmd/server
          go build -o bin/bench ./cmd/bench
      
      - name: Run Benchmarks
        env:
          BENCHMARK_DURATION: ${{ github.event.inputs.duration || '15s' }}
          BENCHMARK_MODE: ${{ github.event.inputs.benchmark_mode || 'baseline' }}
        run: |
          ./bin/bench -mode "$BENCHMARK_MODE" -duration "$BENCHMARK_DURATION" -connections 128 -workers 4
      
      - name: Upload Results
        uses: actions/upload-artifact@v4
        with:
          name: fast-results-x86
          path: results/
          retention-days: 7

  # ============================================================
  # Phase 3: Generate PR Comment
  # ============================================================
  report:
    name: Generate Report
    needs: [benchmark-arm64, benchmark-x86]
    runs-on: ubuntu-latest
    if: always()
    permissions:
      pull-requests: write
      contents: read
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Download ARM64 Results
        uses: actions/download-artifact@v4
        with:
          name: fast-results-arm64
          path: results/arm64
        continue-on-error: true
      
      - name: Download x86 Results
        uses: actions/download-artifact@v4
        with:
          name: fast-results-x86
          path: results/x86
        continue-on-error: true
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Generate Charts
        run: |
          pip install matplotlib numpy
          
          # Generate charts for ARM64
          if [ -d "results/arm64" ] && ls results/arm64/*.json 1>/dev/null 2>&1; then
            mkdir -p results/charts/arm64
            python scripts/generate_charts.py results/arm64 results/charts/arm64
          fi
          
          # Generate charts for x86
          if [ -d "results/x86" ] && ls results/x86/*.json 1>/dev/null 2>&1; then
            mkdir -p results/charts/x86
            python scripts/generate_charts.py results/x86 results/charts/x86
          fi
      
      - name: Upload Charts Artifact
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-charts
          path: results/charts/
          retention-days: 30
      
      - name: Generate PR Comment
        if: github.event_name == 'pull_request'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Build PR comment body
          COMMENT_BODY="## üöÄ Fast Benchmark Results (Preview)
          
          > **Note**: These are quick validation results using virtualized instances.
          > For official results, run the Metal benchmark after merge.
          
          ---
          "
          
          # Add ARM64 results
          if [ -f "results/charts/arm64/summary_arm64.md" ]; then
            COMMENT_BODY+="
          ### üîµ ARM64 (Graviton)
          
          $(cat results/charts/arm64/summary_arm64.md | tail -n +2)
          
          <details>
          <summary>üìä View ARM64 Raw Data</summary>
          
          \`\`\`json
          $(cat results/arm64/*.json 2>/dev/null | head -200)
          \`\`\`
          
          </details>
          
          ---
          "
          else
            COMMENT_BODY+="
          ### üîµ ARM64 (Graviton)
          
          ‚ö†Ô∏è No ARM64 results available (benchmark may have failed)
          
          ---
          "
          fi
          
          # Add x86 results
          if [ -f "results/charts/x86/summary_x86.md" ]; then
            COMMENT_BODY+="
          ### üü¢ x86 (Intel)
          
          $(cat results/charts/x86/summary_x86.md | tail -n +2)
          
          <details>
          <summary>üìä View x86 Raw Data</summary>
          
          \`\`\`json
          $(cat results/x86/*.json 2>/dev/null | head -200)
          \`\`\`
          
          </details>
          
          ---
          "
          else
            COMMENT_BODY+="
          ### üü¢ x86 (Intel)
          
          ‚ö†Ô∏è No x86 results available (benchmark may have failed)
          
          ---
          "
          fi
          
          # Add chart artifacts link
          COMMENT_BODY+="
          ### üìà Charts
          
          Download the full benchmark charts from the [workflow artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}).
          
          | Chart Type | ARM64 | x86 |
          |------------|-------|-----|"
          
          for chart_type in simple json path big-request; do
            COMMENT_BODY+="
          | ${chart_type} throughput | ‚úÖ | ‚úÖ |"
          done
          
          COMMENT_BODY+="
          | latency distribution | ‚úÖ | ‚úÖ |
          
          ---
          
          <sub>Generated by [Celeris Benchmark Suite](https://github.com/${{ github.repository }}) ‚Ä¢ Run ID: ${{ github.run_id }}</sub>
          "
          
          # Post or update comment
          PR_NUMBER=${{ github.event.pull_request.number }}
          
          # Find existing comment
          EXISTING_COMMENT=$(gh api repos/${{ github.repository }}/issues/${PR_NUMBER}/comments \
            --jq '.[] | select(.body | contains("Fast Benchmark Results")) | .id' | head -1)
          
          if [ -n "$EXISTING_COMMENT" ]; then
            # Update existing comment
            gh api repos/${{ github.repository }}/issues/comments/${EXISTING_COMMENT} \
              -X PATCH \
              -f body="$COMMENT_BODY"
            echo "Updated existing comment: $EXISTING_COMMENT"
          else
            # Create new comment
            gh api repos/${{ github.repository }}/issues/${PR_NUMBER}/comments \
              -f body="$COMMENT_BODY"
            echo "Created new comment on PR #${PR_NUMBER}"
          fi
      
      - name: Create Summary
        run: |
          echo "# üöÄ Fast Benchmark Results (Preview)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> **Note**: These are quick validation results using virtualized instances." >> $GITHUB_STEP_SUMMARY
          echo "> For official results, run the Metal benchmark after merge." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## ARM64 Results" >> $GITHUB_STEP_SUMMARY
          if [ -f "results/charts/arm64/summary_arm64.md" ]; then
            cat results/charts/arm64/summary_arm64.md >> $GITHUB_STEP_SUMMARY
          else
            echo "No ARM64 results available" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## x86 Results" >> $GITHUB_STEP_SUMMARY
          if [ -f "results/charts/x86/summary_x86.md" ]; then
            cat results/charts/x86/summary_x86.md >> $GITHUB_STEP_SUMMARY
          else
            echo "No x86 results available" >> $GITHUB_STEP_SUMMARY
          fi

  # ============================================================
  # Cleanup
  # ============================================================
  cleanup:
    name: Cleanup Infrastructure
    needs: [benchmark-arm64, benchmark-x86]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.6.0"
      
      - name: Terraform Destroy
        working-directory: terraform
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          TF_VAR_gh_pat_runner_token: ${{ secrets.GH_PAT_RUNNER_TOKEN }}
        run: |
          terraform init
          terraform destroy -auto-approve || true
